
# 🚀 1단계 - 웹 성능 테스트

## 요구사항
- [X] 웹 성능 테스트
  - [X] 웹 성능 예산을 작성
  - [X] WebPageTest, PageSpeed 등 테스트해보고 개선이 필요한 부분을 파악

### 1단계 - 웹 성능 테스트
1. 웹 성능예산은 어느정도가 적당하다고 생각하시나요

- RunningMap (https://aws.coffee-con.xyz/)
- PageSpeed 기준

|     | Mobile | Desktop | 
|-----|--------|---------| 
| FCP | 14.3 초  | 2.6 초    |
| LCP | 14.9 초  | 2.7 초    |
| TTI | 14.8 초  | 2.7 초    |
| TBT | 340 밀리초  | 50 밀리초    |
| SI | 14.3 초  | 2.6 초   |
| 성능 | 38점 | 68점 |

---

경쟁사

- 네이버 (https://m.map.naver.com/subway/subwayLine.naver?region=1000)

|     | Mobile  | Desktop | 
|-----|---------|---------| 
| FCP | 2.2초 | 0.5초 |
| LCP | 7.8초 | 1.7초 |
| TTI | 5.8 초 | 0.5초 |
| TBT | 210 밀리초 | 0 밀리초 |
| SI  | 5.0 초 | 1.6초 |
| 성능 | 63점 | 92점 |

- 카카오맵 (https://map.kakao.com/?REGION=01&target=subway)

|     | Mobile | Desktop | 
|-----|--------|---------| 
| FCP | 3.3초   | 0.6초 |
| LCP | 5.8초   | 1.9초 |
| TTI | 5.4 초  | 3.5초 |
| TBT | 50 밀리초 | 740 밀리초 |
| SI  | 5.0 초  | 2.2초 |
| 성능 | 63점 | 43점 |

---
웹 성능 예산

1. 타사에 비하여 모바일과 Desktop 성능에 많은 지표가 저하로 보임
   - 모바일 기준 네이버 FCP(2.2초), 카카오 LCP(5.8초), TTI(5.4초) 기준으로 최소 성능 향상을 목표
   - 더 나아가 FCP(1.8)초, LCP(2.5)초, TTI(5초)를 기준으로 우수한 사용자 경험을 제공할 수 있어야함. 

---

3. 웹 성능예산을 바탕으로 현재 지하철 노선도 서비스는 어떤 부분을 개선하면 좋을까요
- 텍스트 기반 리소스를 압축(gzip, deflate, brotli)
- 사용하지 않는 자바스크립트를 제거
- 효율적인 캐시 정책 설정하기
  - CDN, 브라우저 캐시

---

# 🚀 2단계 - 부하테스트

## 요구사항
- [X] 부하 테스트 
  - [X] 테스트 전제조건 정리 
    - [X] 대상 시스템 범위
    - [X] 목푯값 설정 (latency, throughput, 부하 유지기간)
    - [X] 부하 테스트 시 저장될 데이터 건수 및 크기
- [X] 각 시나리오에 맞춰 스크립트 작성
  - [X] 접속 빈도가 높은 페이지
  - [X] 데이터를 갱신하는 페이지
  - [X] 데이터를 조회하는데 여러 데이터를 참조하는 페이지
- [X] Smoke, Load, Stress 테스트 후 결과를 기록

트래픽 예측
- a. 초기 프로젝트 오픈시 예상 최대 DAU 50만으로 예측 (100만의 절반 수치)
- b. 지하철 이용자별 이용량 최대 트래픽수 (약 32만) / 평소 트래픽 (약 10만) = 피크시간대 집중률 (3.2)
- c. 1명당 1일 평균 접속 혹은 요청수를 예상해봅니다. 
  - Throughput : 1일 평균 rps ~ 1일 최대 rps
    - 1일 평균 rps [DAU 50만 / 86400] = 약 최대 6rps (카카오는 평균 1명당 3번 접속)
    - 1일 평균 6rps * (32만 / 10만 = 3.2) = 1일 최대 RPS 3.2 * 6 = 약 19 RPS

- VUser [R(요청수) * http_req_duration) + 1s = T
- 6 * 0.1 = 0.6
- 1일 평균 목표 (평균 6prs * 시간 0.6) / 5(요청수) = 0.72(약 1rps)
- 1일 최대 목표 (최대 19*rps * 시간 0.6) / 5(요청수) = 2.28(약 3rps)

- 약 일일 사용자 예측 (카카오 지하철 기준 100~150만)
- 초기 프로젝트 오픈시 예상 DAU 50만으로 예측 (100만의 절반 수치)
- 참고 페이지 [https://www.mobiinside.co.kr/2016/09/28/kakao-app/]
- 참고 페이지 [https://data.seoul.go.kr/dataList/OA-12252/S/1/datasetView.do]

---

### 로그 설정하기
- [X] Application Log 파일로 저장하기
  - 회원가입, 로그인 등의 이벤트에 로깅을 설정 
  - 경로찾기 등의 이벤트 로그를 JSON으로 수집
- [X] Nginx Access Log 설정하기

### Cloudwatch로 모니터링
- [] Cloudwatch로 로그 수집하기 
- [] Cloudwatch로 메트릭 수집하기 
- [] USE 방법론을 활용하기 용이하도록 대시보드 구성

### 로깅시 주의점
- Avoid side effects
  - logging으로 인해 애플리케이션 기능의 동작에 영향을 미치지 않아야 합니다.
  - 예를 들어 logging하는 시점에 NullPointerException이 발생해 프로그램이 정상적으로 동작하지 않는 상황이 발생하면 안됩니다.
- Be concise and descriptive
  - 각 Logging에는 데이터와 설명이 모두 포함되어야 합니다.
- Log method arguments and return values
  - 메소드의 input과 output을 로그로 남기면 debugger를 사용해 디버깅하지 않아도 됩니다. 특히 debugger를 사용할 수 없는 상황에서는 상당히 유용하게 사용할 수 있습니다.
  - 이를 구현하려면 메소드 앞 부분과 뒷 부분에 지저분한 중복 코드가 계속해서 발생하는 상황이 발생하는데 이는 AOP를 통해 해결할 수 있습니다.
- Delete personal information
  - 로그에 사용자의 전화번호, 계좌번호, 패스워드, 주소, 전화번호와 같은 개인정보를 남기지 않습니다.

### logging level
- Logging Level을 적절하게 나눠 구현하는 것이 신경쓰면서 개발해야 합니다.
  - ERROR : 예상하지 못한 심각한 문제가 발생하여 즉시 조사해야 함
  - WARN : 로직상 유효성 확인, 예상 가능한 문제로 인한 예외처리 등을 남김, 서비스는 운영될 수 있지만, 주의해야 함
  - INFO : 운영에 참고할만한 사항으로, 중요한 비즈니스 프로세스가 완료됨
  - DEBUG / TRACE : 개발 단계에서만 사용하고 운영 단계에서는 사용하지 않음

- 즉, DEBUG 레벨로 설정하면 DEBUG 레벨보다 높은 로그 레벨의 메시지가 모두(DEBUG, INFO, WARN, ERROR) 출력됩니다. 
  - ERROR 레벨로 설정하면 ERROR 레벨의 로그만 출력되는 방식으로 동작합니다.

### Application Log
- 애플리케이션의 상태를 확인하기 위해서는 로그를 남기는 것이 중요합니다. 무엇을 로그로 남겨야 할지, 로그를 어떻게 관리해야 할지 고민이 필요

### Nginx Log
- volume 옵션을 활용하여 호스트의 경로와 도커의 경로를 마운트합니다.

---

## 용어
First Contentful Paint(최초 콘텐츠풀 페인트, FCP)
- 최초 콘텐츠풀 페인트(FCP) 메트릭은 페이지가 로드되기 시작한 시점부터 페이지 콘텐츠의 일부가 화면에 렌더링될 때까지의 시간
- 우수한 사용자 경험을 제공하려면 사이트의 최초 콘텐츠풀 페인트가 1.8초 이하여야 합니다.

Largest Contentful Paint(최대 콘텐츠풀 페인트, LCP)
- 최대 콘텐츠풀 페인트(LCP) 메트릭은 페이지가 처음으로 로드를 시작한 시점을 기준으로 뷰포트 내에 있는 가장 큰 이미지 또는 텍스트 블록의 렌더링 시간
- 우수한 사용자 경험을 제공하려면 사이트의 최대 콘텐츠풀 페인트가 2.5초 이하여야 합니다.

Time to Interactive(상호 작용까지의 시간, TTI)
- TTI 메트릭은 페이지가 로드되기 시작한 시점부터 주요 하위 리소스가 로드되고 사용자 입력에 신속하게 안정적으로 응답할 수 있는 시점까지의 시간
- 우수한 사용자 경험을 제공하기 위해 사이트는 평균 모바일 하드웨어에서 테스트할 때 상호 작용까지의 시간이 5초 미만이 될 수 있도록 해야 합니다.
